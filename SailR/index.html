<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SailR</title>
    <script src="static/jquery-3.5.1.min.js" ></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="static/leaflet/leaflet.css"/>
    <script src="static/leaflet/leaflet.js" ></script>
    <!--leaflet-velocity-->
    <link rel="stylesheet" href="static/velocity/leaflet-velocity.css" />
    <script src="static/velocity/leaflet-velocity.js"></script>
    <script src="static/velocity/IE_workarounds.js"></script>
    <!-- add Leafleet rotate -->
    <script type="text/javascript" src="static/leaflet.rotatedMarker.js"></script>
    <!-- add Leafleet terminator -->
    <script src="https://unpkg.com/@joergdietrich/leaflet.terminator"></script>
    <!-- add Leafleet sidebar -->
    <link rel="stylesheet" href="static/leaflet-sidebar/src/L.Control.Sidebar.css" />
    <script src="static/leaflet-sidebar/src/L.Control.Sidebar.js"></script>
    <!--for timeslider-->
    <script type="text/javascript" src="static/timedimension/iso8601.min.js"></script>
    <script type="text/javascript" src="static/timedimension/leaflet.timedimension.noLayers.src.js"></script>
    <link rel="stylesheet" href="static/timedimension/leaflet.timedimension.control.min.css" />
    <!-- load variable values from server-->
    <script type="text/javascript" src="https://weather.openportguide.org/weather/javascript_vars.js"></script>
    <script type="text/javascript" src="https://weather.openportguide.org/weather/javascript_vars_rtofs.js"></script>
    <!-- add Polyline -->
	  <link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css" />
    <script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js"></script>
    <!-- add Navionics -->
    <link rel="stylesheet" href="https://webapiv2.navionics.com/dist/webapi/webapi.min.css" >
    <script type="text/javascript" src="https://webapiv2.navionics.com/dist/webapi/webapi.min.no-dep.js"></script>
    <!-- add chartjs -->
    <link rel="stylesheet" href="static/chartjs/Chart.min.css" >
    <script type="text/javascript" src="static/chartjs/Chart.min.js"></script>
    <!-- add timer -->
    <script type="text/javascript" src="static/easytimer.min.js"></script>
    <!-- fontello -->
    <link rel="stylesheet" href="static/fontello/css/fontello.css" />
    <!-- Custom -->
    <link rel="stylesheet" href="static/style.css" />
  </head>
  <body>

      <div id="map"></div>
      <div class="black-container">
        <div class="container chronodata">
          <div id="timer">
            <div>Chronométre</div>
            <div><span class="blue">J+</span><span class="days blue">00</span> <span class="hours">00</span><span class="blue">:</span><span class="minutes">00</span><span class="blue">:</span><span class="seconds">00</span></div>
          </div>
          <div>
            <div>Skippers en course</div>
            <div><span class="blue" id="skipperCount">33</span> / 33</div>
        </div>
      </div>
      <div id="sidebar">
        <button id="close"><i class="icon-cancel-circle"></i></button>
       <div class="header">
          <img id="data_skipper_pict"  src="static/img/avatar/default.jpg" class="skipper_pict" />
          <div>
            <h1 id="data_skipper">--</h1>
            <h2><span id="data_team">--</span><span id="data_foiler" class="boat-type">--</span><h2>
          </div>
       </div>
       <div class="bloc metrics">
         <div><div>Position</div><div id="data_postion">--</div></div>
         <div><div>Vitesse</div><div id="data_speed">--</div></div>
         <div><div>Cap</div><div id="data_heading">--</div></div>
       </div>
       <div class="bloc">
          <h2 class="sidebar-title">Vitesse sur 24 heures</h2>
          <canvas id="speedChart" height="150"></canvas>
       </div>
       <div class="bloc">
        <h2 class="sidebar-title">Historique classement</h2>
        <div class="tableOverflow">
          <table cellspacing="0" id="positionHistory">
            <thead>
              <tr>
                <th>Jour</th>
                <th>classement</th>
                <th>VMG</th>
              </tr>
              <tbody></tbody>
            </thead>
          </table>
        </div>
        <div class="gradient"></div>
        </div>
        <div class="bloc metrics">
          <div><div>Distance restante</div><div id="data_dist">--</div></div>
          <div><div>VMG MAX</div><div id="data_vmgmax">--</div></div>
        </div>
      </div>
    </div>

    <script>
    window.onload = function() {
      var depart = new Date(2020, 10, 8, 14, 20);
      var dateNow = new Date();
      var timerdelta = Math.abs(dateNow -depart) / 1000;
      console.log(timerdelta)
      var timer = new easytimer.Timer();
      timer.start({precision: 'seconds', startValues: {seconds: timerdelta}});
      timer.addEventListener('secondsUpdated', function (e) {
          $('#timer .days').html(('0' + timer.getTimeValues().days).slice(-2));
          $('#timer .hours').html(('0' + timer.getTimeValues().hours).slice(-2));
          $('#timer .minutes').html(('0' + timer.getTimeValues().minutes).slice(-2));
          $('#timer .seconds').html(('0' + timer.getTimeValues().seconds).slice(-2));
      });

      // ----- CARTO ----- //

      // var
      var startTime = new Date(Date.UTC(GFS_server_year, GFS_server_month - 1, GFS_server_day, GFS_server_hour));
      var actualTime = new Date(Date.UTC(GFS_server_year, GFS_server_month - 1, GFS_server_day, GFS_server_hour + 6)); //actual time is about 6 hours ahead to the first forecast timestep
      var endTime = new Date(Date.UTC(GFS_server_year, GFS_server_month - 1, GFS_server_day, GFS_server_hour + ((GFS_timesteps-1)*GFS_interval)));
      var dataTimeInterval = startTime.toISOString() + "/" + endTime.toISOString();
      var actualInterval = GFS_interval*2 ; // show only every second available timestep (GFS_interval is "3" hours
      var dataPeriod = "PT" + (actualInterval) + "H";

      function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return parseInt(result[1], 16) +', '+ parseInt(result[2], 16)+ ', '+ parseInt(result[3], 16);
      }

      function setSideBarChartConfig(label, data){
        return {
          type: 'line',
          data: {
            labels: label,
            datasets: [{
              label: 'Speed dataset',
              borderColor: '#01A7FA',
              data: data,
              fill: false,
              pointBorderColor: '#01A7FA',
              pointBackgroundColor: '#01A7FA',
              pointBorderWidth: 4,
              lineTension: 0.2,
              borderWidth:4,
            }]
          },
          options: {
            scales: {
              yAxes: [{
                  ticks: {
                      beginAtZero: true,
                      fontColor: '#FFFFFF'
                  },
                  gridLines: {
                    color: "#333A43",
                    zeroLineColor: '#333A43'
                  },
              }],
              xAxes: [{
                ticks: {
                    fontColor: '#FFFFFF'
                },
                gridLines: {
                  zeroLineColor: '#333A43',
                  color: "#333A43",
                  borderDash: [8, 8],
                }
              }]
            },
            legend: {
              display: false
            },
            tooltips: {
              enabled: false
            }
          }
        };
      }

      // Set map
      var map = L.map(
        'map',
        {
          zoomControl: false,
          timeDimension: true,
          timeDimensionOptions: {
            timeInterval: dataTimeInterval,
            period: dataPeriod,
            currentTime: actualTime
          },
          timeDimensionControl: true,
          timeDimensionControlOptions: {
          position: "bottomright",
          loopButton: false,
          limitSliders: false,
          playButton: false,
          speedSlider: false
        } }).setView({lon: 0, lat: 0}, 2);


        // --- LAYOUTS --- //

        // Add OSM tiles
        var clear = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
        }).addTo(map);


        // Add OSM tiles
        var dark = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
          maxZoom: 20,
          attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
        });


        // Add Imagery tiles
        var satelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });


        // Add Zoom control
        L.control.zoom({
            position: 'topright'
        }).addTo(map);


        // Add Polyline Measure
        var optionspoly = {position: 'topright',unit: 'nauticalmiles', showClearControl: true,showBearings: true};
        L.control.polylineMeasure(optionspoly).addTo(map);


        // Navionics Overlay
        // var myNavionicsOverlay = new JNC.Leaflet.NavionicsOverlay({
        //   navKey: 'Navionics_webapi_00583',
        //   chartType: JNC.NAVIONICS_CHARTS.NAUTICAL,
        //   isTransparent: false,
        //   logoPayoff: false,
        //   zIndex: 1
        // }).addTo(map);


        // Add openSeaMap Overlay
        var openSeaMap = L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
          attribution: 'Map data: &copy; <a href="http://www.openseamap.org">OpenSeaMap</a> contributors'
        }).addTo(map);


        // Wind
        var baseIndex = 1;
        var wind10mBaseURL = 'https://weather.openportguide.org/weather/wind10m/';
        var wind10mBaseName = 'wind10m_{h}h';
        var wind10mName = '';
        var wind10mArray = [];

        var wind10mLayerGroup = new L.layerGroup([], {});
        wind10mArray.length = map.timeDimension._availableTimes.length;
        var actualTimeIndex = map.timeDimension._currentTimeIndex;
        updateLayer(wind10mArray[actualTimeIndex]);

        function updateLayer(Layer){ //updates the actual layer
          wind10mLayerGroup.clearLayers();
          wind10mName = wind10mBaseName.replace(/{h}/g, (actualTimeIndex - baseIndex) * actualInterval);
          
          $.getJSON(wind10mBaseURL + wind10mName + ".json", function(data) {
            this[wind10mName] = L.velocityLayer({
                displayValues: true,
                displayOptions: {
                    velocityType: "Wind",
                    emptyString: "No wind data",
                    angleConvention: "MeteoCW",
                    speedUnit: "kt"
                },
                data: data,
                minVelocity: 0,
                maxVelocity: 30,
                particleAge: 90,
                lineWidth: 1,
                particleMultiplier: 0.0033,
                frameRate: 25,
                colorScale: ["#2468b4", "#3c9dc2", "#80cdc1", "#97daa8", "#c6e7b5", "#eef7d9", "#ffee9f", "#fcd97d", "#ffb664", "#fc964b", "#fa7034", "#f54020", "#ed2d1c", "#dc1820", "#b40023"]
              });
        
            wind10mLayerGroup.addLayer(this[wind10mName]);
            wind10mArray[actualTimeIndex] = wind10mLayerGroup.getLayer(wind10mLayerGroup.getLayerId(this[wind10mName]));
            wind10mLayerGroup;
          });
        }

        window.setInterval(function() { //check if time index changed
          if (actualTimeIndex != map.timeDimension._currentTimeIndex) {
          actualTimeIndex = map.timeDimension._currentTimeIndex;
          updateLayer(wind10mArray[actualTimeIndex]);
          }
        },100);

        // ------ TERMINATOR ----- //
        var terminator = L.terminator().addTo(map);
        setInterval(function() {
          terminator.setTime();
        }, 60000);

        
        // ----- LAYER CONTROL ---- //

        var baseLayers = {
          "Clear" : clear,
          "Dark" : dark,
          "Satelite" : satelit
          
        };
        
        var overlays = {
          "OpenSeaMap" : openSeaMap,
          "Wind": wind10mLayerGroup,
          "Day/Night": terminator,
          //"Navionics" : myNavionicsOverlay
        };

        layerControl = L.control.layers(baseLayers, overlays, {position: 'topleft'});
        layerControl.addTo(map);

        // ------- DST DATA ------ //
        $.getJSON( "dst.json"+"?"+Math.random(), function( data ) {
          L.polygon(data, {color: "red", weight: 1}).addTo(map);
        }); 

        // ------ SIDEBAR ----- //

        var sidebar = L.control.sidebar('sidebar', {
            position: 'left',
            closeButton: 'true'
        });
        map.addControl(sidebar);

        $('#close').click(function(){sidebar.hide();});

        // ------ BOAT DATA ------ //
        var boatPositions = [];

        $.getJSON( "vg2020.json"+"?"+Math.random(), function( data ) {
          $.each( data, function( key, val ) {
            var latlngs = [];
            var lastPosition = null;
            var lastRotation = null;
            
            $.each( val.classements, function( elemK, elemV ) {
              lastPosition = [elemV.latitude, elemV.longitude];
              lastRotation = elemV.cap;
              latlngs.push(lastPosition);
            }); 
            
            // Trace boat line
            var polyline = L.polyline(latlngs, {color: val.couleur}).addTo(map);
            
            // Design boat icon
            var width = 40;
            var height = 60;
            var boatIcon = L.icon({
                iconUrl: 'static/img/markers/' + key + '.png',
                iconSize:     [width, height],
                iconAnchor:   [width/2, width/2],
                popupAnchor:  [0, 0]
            });
          
          // Add boa on map
          var boat = L.marker(lastPosition, {id: key, icon: boatIcon, rotationAngle: lastRotation,title:val.skipper}).addTo(map);
          
          // Add click boat
          boat.on("click", function(event){
            var id = event.sourceTarget.options.id;
            openSidebar(id);
          });
          
          boatPositions.push(lastPosition);
        });

          // autoFit map
          map.fitBounds(boatPositions);

          // Count boat for skipper count
          $('#skipperCount').html(boatPositions.length);

        });
        
        // ----- SIDEBAR POPULATE FUNCTION ----- //
        
        function openSidebar(id){
          var url = "skipper.json"+"?id="+id+'&r='+Math.random();
          $.getJSON( url, function( skipperData ) {
            sidebar.show();
            // Stuff
            $('#data_skipper_pict').attr('src', 'static/img/avatar/'+skipperData.number+'.jpg');
            $('#data_skipper_pict').attr('style', 'border-color:'+skipperData.color+'; box-shadow:0 0 0 10px rgba('+hexToRgb(skipperData.color)+',0.2);');
            $('#data_skipper').text(skipperData.skipper);
            $('#data_team').text(skipperData.team);
            $('#data_postion').text(skipperData.position);
            $('#data_speed').text(skipperData.speed);
            $('#data_heading').text(skipperData.heading+'°');
            $('#data_dist').text(skipperData.dist+' nm');
            $('#data_vmgmax').text(skipperData.vmgmax+' nds');

            // Foiler
            if (skipperData.foiler){
              $('#data_foiler').text('foiler').addClass('foiler').removeClass('derive');
            } else {
              $('#data_foiler').text('Derives').addClass('derive').removeClass('foiler');
            }

            // Speed chart
            var speed_history = skipperData.speed_history;
            var labels = [];
            for (var i = 0; i < speed_history.length; ++i) {
              labels.push('+'+i.toString());
            }
            console.log(labels)
            var ctx = document.getElementById('speedChart').getContext('2d');
            var sidebarChart = new Chart(ctx, setSideBarChartConfig(labels, speed_history));
        
            // position history
            var htmlData = '';
            $.each(skipperData.position_history, function(key, val) {
              htmlData += '<tr><td><span class="grey">J+</span>'+skipperData.position_history[key][0]+'</td><td>'+skipperData.position_history[key][1]+'</td><td>'+skipperData.position_history[key][2]+' <span class="grey">nds</span></td></tr>';
            });
            $('#positionHistory>tbody').html(htmlData);
          });
        }
      
      };
    </script>
  </body>
</html>