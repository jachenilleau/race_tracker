<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta -->
    <link rel="apple-touch-icon" sizes="57x57" href="static/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="static/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="static/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="static/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="static/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="static/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="static/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="static/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="static/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="static/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="static/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="static/favicon/favicon-16x16.png">
    <link rel="manifest" href="static/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E2XG6MBSDG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-E2XG6MBSDG');
    </script>

    <meta name="twitter:image" content="http://volodiaja.net/Tracking/static/img/share.png">
		<meta name="google-site-verification" content="k8kJi61_0jGlwWCuvUGDptZN8vge3fufTIGPZ7Napfk" />
		<meta name="twitter:title" content="Sailing Race Tracker - Vendée Globe 2020/21">
		<meta name="twitter:description" content="Tracker pour suivre les courses nautiques en temps réel - Vendée Globe 2020/21">
		<meta name="description" content="Tracker pour suivre les courses nautiques en temps réel - Vendée Globe 2020/21" />
		<meta name="author" content="Sailing Race Tracker" />
		<meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@volodia">
    
    <meta property="og:url" content="http://volodiaja.net/Tracking" />
		<meta property="og:image" content="http://volodiaja.net/Tracking/static/img/share.png" />
		<meta property="og:image:type" content="image/png">
		<meta property="og:title" content="Sailing Race Tracker - Vendée Globe 2020/21" />
		<meta property="og:description" content="Tracker pour suivre les courses nautiques en temps réel - Vendée Globe 2020/21" />
		<meta property="og:image:height" content="255">
		<meta property="og:image:width" content="400">
		<meta property="og:type" content="website"/>
    

    <title>SailR</title>
    <script src="static/jquery-3.5.1.min.js" ></script>
    <script src="static/moment.js" ></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="static/leaflet/leaflet.css"/>
    <script src="static/leaflet/leaflet.js" ></script>
    <script src="static/L.Path.DashFlow.js" ></script>
    <script src="static/leaflet.antimeridian-src.js" ></script>
    <!--leaflet-velocity-->
    <link rel="stylesheet" href="static/velocity/leaflet-velocity.css" />
    <script src="static/velocity/leaflet-velocity.js"></script>
    <script src="static/velocity/IE_workarounds.js"></script>
    <!-- add Leafleet rotate -->
    <script type="text/javascript" src="static/leaflet.rotatedMarker.js"></script>
    <!-- add Leafleet terminator -->
    <script src="https://unpkg.com/@joergdietrich/leaflet.terminator"></script>
    <!-- add Leafleet sidebar -->
    <link rel="stylesheet" href="static/leaflet-sidebar/src/L.Control.Sidebar.css" />
    <script src="static/leaflet-sidebar/src/L.Control.Sidebar.js"></script>
    <!--for timeslider-->
    <script type="text/javascript" src="static/timedimension/iso8601.min.js"></script>
    <script type="text/javascript" src="static/timedimension/leaflet.timedimension.noLayers.src.js"></script>
    <link rel="stylesheet" href="static/timedimension/leaflet.timedimension.control.min.css" />
    <!-- load variable values from server-->
    <script type="text/javascript" src="https://weather.openportguide.org/weather/javascript_vars.js"></script>
    <script type="text/javascript" src="https://weather.openportguide.org/weather/javascript_vars_rtofs.js"></script>
    <!-- add Polyline -->
	  <link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css" />
    <script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js"></script>
    <!-- add Navionics -->
    <link rel="stylesheet" href="https://webapiv2.navionics.com/dist/webapi/webapi.min.css" >
    <script type="text/javascript" src="https://webapiv2.navionics.com/dist/webapi/webapi.min.no-dep.js"></script>
    <!-- add chartjs -->
    <link rel="stylesheet" href="static/chartjs/Chart.min.css" >
    <script type="text/javascript" src="static/chartjs/Chart.min.js"></script>
    <script type="text/javascript" src="static/chartjs-plugin-annotation.js"></script>
    <!-- add timer -->
    <script type="text/javascript" src="static/easytimer.min.js"></script>
    <!-- fontello -->
    <link rel="stylesheet" href="static/fontello/css/fontello.css" />
    <!-- fontello -->
    <script type="text/javascript" src="static/tablesorter/dist/js/jquery.tablesorter.min.js"></script>
    <!-- mouse coordinates -->
    <link rel="stylesheet" href="static/mousecoordinates/L.Control.MousePosition.css" />
    <script src="static/mousecoordinates/L.Control.MousePosition.js"></script>
    <!-- Custom -->
    <link rel="stylesheet" href="static/style.css?v=12" />
  </head>
  <body>
    <div class="black-container">
      <div class="container txtheader">Cartographie non officielle du <span class="blue">Vendée-Globe 2020/2021</span> - <a target="_blank" href="https://github.com/volodiaja/race_tracker/">Github</a></div>
      </div>
      
      <div id="map"></div>
      
      <div id="footer" class="black-container">
        <div class="container chronodata">
          <div id="timer">
            <div>Chronométre</div>
            <div><span class="blue">J+</span><span class="days blue">00</span> <span class="hours">00</span><span class="blue">:</span><span class="minutes">00</span><span class="blue">:</span><span class="seconds">00</span></div>
          </div>
          <div>
            <div>Skippers en course</div>
            <div><span class="blue" id="skipperCount">33</span> / 33</div>
          </div>
       </div>
      </div>
      
      <div>
        <div class="container">
          <div class="responsivetable">
          <table cellspacing="0" id="Ranking">
            <thead>
              <tr>
                <th>Classement</th>
                <th>Cl. Open</th>
                <th>Skipper</th>
                <th>Vitesse</th>
                <th>Cap</th>
                <th>DTL</th>
                <th>DTL open</th>
                <th>DTF</th>
                <th>VMG</th>
                <th>VMG open</th>
              </tr>
              <tbody></tbody>
            </thead>
          </table>
          </div>
        </div>
      </div>

      <div id="sidebar">
        <button id="close"><i class="icon-cancel-circle"></i></button>
       <div class="header">
          <img id="data_skipper_pict"  src="static/img/avatar/default.jpg" class="skipper_pict" />
          <div>
            <h1 id="data_skipper">--</h1>
            <h2><span id="data_team">--</span><span id="data_foiler" class="boat-type">--</span><h2>
          </div>
       </div>
       <div class="bloc metrics">
         <div><div>Position</div><div id="data_postion">--</div></div>
 
          <div>
            <div>Vitesse</div>
            <div class="withicon">
              <div class="icondata" id='data_speedforce'>
              <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
              viewBox="0 0 32 32" style="enable-background:new 0 0 32 32;" xml:space="preserve">
              <g transform="matrix(-1,0,0,1,32,0)">
                <path d="M14.995,11.314C12.764,10.494 11.17,8.349 11.17,5.835C11.17,2.615 13.785,0 17.005,0L17.005,13.053C17.916,13.364 18.637,14.085 18.947,14.995L20.686,14.995C21.506,12.764 23.651,11.17 26.165,11.17C29.385,11.17 32,13.785 32,17.005L18.947,17.005C18.636,17.916 17.915,18.637 17.005,18.947L17.005,20.653L16.914,20.653C19.193,21.448 20.83,23.617 20.83,26.165C20.83,29.385 18.215,32 14.995,32L14.995,18.947C14.084,18.636 13.363,17.915 13.053,17.005L11.314,17.005C10.494,19.236 8.349,20.83 5.835,20.83C2.615,20.83 0,18.215 0,14.995L13.053,14.995C13.364,14.084 14.085,13.363 14.995,13.053L14.995,11.314Z"/>
              </g>
              </svg>
            </div>
            <span id="data_speed">--</span>
           </div>
          </div>

         <div>
          <div>Cap</div>
          <div class="withicon">
            <div class="icondata" id='data_cap'>
            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            viewBox="0 0 32 32" style="enable-background:new 0 0 32 32;" xml:space="preserve">
              <path d="M9.872,32C9.872,32 9.454,24.217 9.946,20.372C10.943,12.579 14.257,4.131 15.495,1.171C15.576,0.983 15.761,0.861 15.966,0.861C16.171,0.861 16.357,0.983 16.438,1.171C17.675,4.131 20.989,12.579 21.986,20.372C22.477,24.217 22.059,32 22.059,32L9.872,32Z"/>
            </svg>
          </div>
          <span id="data_heading">--</span>
         </div>
        </div>
       </div>

       <div class="bloc metrics">
         <div><div>Vent</div>
         <div class="withicon">
           <div class="icondata" id='data_direction'>
            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            viewBox="0 0 511.998 511.998" style="enable-background:new 0 0 511.998 511.998;" xml:space="preserve">
              <path d="M505.743,6.249c-6.08-6.101-15.211-7.893-23.168-4.672l-469.333,192c-8.768,3.605-14.123,12.544-13.12,21.973
                c0.981,9.429,8.064,17.067,17.387,18.773l220.139,40.021l40.043,220.139c1.685,9.323,9.323,16.405,18.752,17.408
                c0.747,0.064,1.493,0.107,2.219,0.107c8.576,0,16.448-5.184,19.755-13.269l192-469.333
                C513.658,21.459,511.823,12.329,505.743,6.249z"/>
            </svg>
          </div>
           <span id="data_vent">--</span>
          </div>
        </div>

         <div><div>Pluie</div>
          <div class="withicon">
            <div  class="icondata">
              <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
              viewBox="0 0 410.823 410.823" style="enable-background:new 0 0 410.823 410.823;" xml:space="preserve">
               <path d="M5.595,254.875c-17.185,46.513,6.539,98.118,53.048,115.317c46.474,17.203,98.103-6.577,115.312-53.046
                 c17.175-46.468-31.479-173.544-31.479-173.544S22.821,208.372,5.595,254.875z M35.054,273.141
                 c5.685,50.553,34.358,67.908,34.358,67.908C18.311,325.793,35.054,273.141,35.054,273.141z"/>
               <path d="M395.391,259.702c0,0-52.531,28.454-60.083,48.864c-7.54,20.411,2.873,43.066,23.285,50.616
                 c20.399,7.535,43.06-2.884,50.614-23.278C416.761,315.505,395.391,259.702,395.391,259.702z M348.232,316.572
                 c2.503,22.202,15.086,29.817,15.086,29.817C340.889,339.719,348.232,316.572,348.232,316.572z"/>
               <path d="M368.837,177.115c14.061-38.057-25.778-142.083-25.778-142.083s-97.944,53.086-112.03,91.106
                 c-14.074,38.028,5.364,80.34,43.398,94.384C312.473,234.624,354.746,215.17,368.837,177.115z M255.121,141.088
                 c4.663,41.38,28.137,55.596,28.137,55.596C241.416,184.205,255.121,141.088,255.121,141.088z"/>
               </svg>
          </div>
            <span id="data_pluie">--</span>
          </div>
         </div>
         <div><div>Nuages</div>
         <div class="withicon">
          <div  class="icondata">
            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
              viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve">
              <path d="m255.736 186.569c2.627-.214 5.264-.322 7.902-.322 22.617 0 43.44 7.823 59.911 20.902 6.253-1.256 12.695-1.915 19.259-1.915 41.721 0 78.592 26.539 92.5 64.828 2.763-.233 5.538-.35 8.315-.35 8.377 0 16.511 1.055 24.28 3.035 5.46-15.417 8.443-31.996 8.443-49.26 0-81.581-66.371-147.951-147.951-147.951-48.212 0-91.108 23.184-118.136 58.985 20.734 11.035 37.196 29.435 45.477 52.048z"/>
              <path d="m241.994 269.712c2.777 0 5.553.117 8.314.35 7.368-20.283 21.182-37.267 38.746-48.757-7.835-3.252-16.417-5.057-25.416-5.057-5.15 0-10.285.591-15.26 1.758-3.948.926-8.104.214-11.519-1.976-3.415-2.188-5.798-5.667-6.605-9.641-6.263-30.814-33.674-53.179-65.179-53.179-31.504 0-58.915 22.365-65.179 53.18-.808 3.975-3.19 7.453-6.605 9.641-3.414 2.188-7.569 2.903-11.519 1.975-4.974-1.167-10.108-1.758-15.26-1.758-36.674 0-66.512 29.837-66.512 66.513s29.838 66.514 66.514 66.514h78.917c8.804-45.276 48.751-79.563 96.563-79.563z"/>
              <path d="m443.624 299.712c-5.296 0-10.573.608-15.688 1.807-3.948.927-8.104.214-11.519-1.975-3.415-2.188-5.798-5.667-6.605-9.642-6.438-31.677-34.617-54.669-67.004-54.669-32.386 0-60.564 22.992-67.004 54.669-.808 3.975-3.19 7.453-6.605 9.641-3.415 2.19-7.57 2.901-11.52 1.975-5.112-1.199-10.39-1.807-15.686-1.807-37.702 0-68.376 30.673-68.376 68.376s30.674 68.376 68.376 68.376h201.63c37.703 0 68.376-30.673 68.376-68.376s-30.672-68.375-68.375-68.375z"/>
              </svg>
          </div>
          <span id="data_nuage">--</span>
        </div>
       </div>
       </div>
       <div class="bloc">
          <h2 class="sidebar-title">Vitesse sur 48 heures</h2>
          <canvas id="speedChart" height="150"></canvas>
       </div>
       <div class="bloc">
        <h2 class="sidebar-title">Historique classement</h2>
        <div class="tableOverflow">
          <table cellspacing="0" id="positionHistory">
            <thead>
              <tr>
                <th>Jour</th>
                <th>classement</th>
                <th>VMG</th>
              </tr>
              <tbody></tbody>
            </thead>
          </table>
        </div>
        <div class="gradient"></div>
        </div>
        <div class="bloc metrics">
          <div><div>Distance restante</div><div id="data_dist">--</div></div>
          <div><div>VMG MAX</div><div id="data_vmgmax">--</div></div>
        </div>
      </div>
    </div>

    <script>
    window.onload = function() {
      var depart = new Date(2020, 10, 8, 14, 20);
      var dateNow = new Date();
      var timerdelta = Math.abs(dateNow -depart) / 1000;
             
      function truncate(str, n){
        return (str.length > n) ? str.substr(0, n-1) + '&hellip;' : str;
      };

      function windcolor(force){
        var colors = ['#ffffff', '#eaf0db', '#dfdfb1', '#e1ca7c', '#ffa71d', '#ff8b1b', '#f97025', '#ef5532', '#e03a42', '#cc1e55', '#b1016d', '#8b008b'];
          if(force <=1){
            return colors[0];
          }
          if(force <=5){
            return colors[1];
          }
          if(force <=11){
            return colors[2];
          }
          if(force <=19){
            return colors[3];
          }
          if(force <=28){
            return colors[4];
          }
          if(force <=38){
            return colors[5];
          }
          if(force <=49){
            return colors[6];
          }
          if(force <=61){
            return colors[7];
          }
          if(force <=74){
            return colors[8];
          }
          if(force <=88){
            return colors[9];
          }
          if(force <=102){
            return colors[10];
          }
          if(force <=112){
            return colors[11];
          }
          if(force <=117){
            return colors[12];
          }
          return colors[18];
      }

      var timer = new easytimer.Timer();
      timer.start({precision: 'seconds', startValues: {seconds: timerdelta}});
      timer.addEventListener('secondsUpdated', function (e) {
          $('#timer .days').html(('0' + timer.getTimeValues().days).slice(-2));
          $('#timer .hours').html(('0' + timer.getTimeValues().hours).slice(-2));
          $('#timer .minutes').html(('0' + timer.getTimeValues().minutes).slice(-2));
          $('#timer .seconds').html(('0' + timer.getTimeValues().seconds).slice(-2));
      });

      // ----- CARTO ----- //

      // var
      var startTime = new Date(Date.UTC(GFS_server_year, GFS_server_month - 1, GFS_server_day, GFS_server_hour));
      var actualTime = new Date(Date.UTC(GFS_server_year, GFS_server_month - 1, GFS_server_day, GFS_server_hour + 6)); //actual time is about 6 hours ahead to the first forecast timestep
      var endTime = new Date(Date.UTC(GFS_server_year, GFS_server_month - 1, GFS_server_day, GFS_server_hour + ((GFS_timesteps-1)*GFS_interval)));
      var dataTimeInterval = startTime.toISOString() + "/" + endTime.toISOString();
      var actualInterval = GFS_interval*2 ; // show only every second available timestep (GFS_interval is "3" hours
      var dataPeriod = "PT" + (actualInterval) + "H";

      function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return parseInt(result[1], 16) +', '+ parseInt(result[2], 16)+ ', '+ parseInt(result[3], 16);
      }

      function setSideBarChartConfig(label, data, average, min, max){
        return {
          type: 'line',
          data: {
            labels: label,
            datasets: [{
              label: 'Speed dataset',
              borderColor: '#01A7FA',
              data: data,
              fill: false,
              pointBorderColor: '#01A7FA',
              pointBackgroundColor: '#01A7FA',
              pointBorderWidth: 4,
              lineTension: 0.2,
              borderWidth:4,
            }]
          },
          options: {
            scales: {
              yAxes: [{
                  ticks: {
                      
                      fontColor: '#FFFFFF',
                      suggestedMin: min,
                      suggestedMax: max,
                  },
                  gridLines: {
                    color: "#333A43",
                    zeroLineColor: '#333A43'
                  },
              }],
              xAxes: [{
                ticks: {
                    fontColor: '#FFFFFF'
                },
                gridLines: {
                  zeroLineColor: '#333A43',
                  color: "#333A43",
                  borderDash: [8, 8],
                }
              }]
            },
            legend: {
              display: false
            },
            tooltips: {
              enabled: false
            },
            annotation: {
              annotations: [{
                type: 'line',
                mode: 'horizontal',
                scaleID: 'y-axis-0',
                value: average,
                borderColor: 'rgba(220,20,60, 0.7)',
                borderWidth: 2,
                label: {
                  enabled: false,
                  content: 'Average'
                }
              }]
            }
          }
        };
      }

      // Set map
      var map = L.map(
        'map',
        {
          zoomControl: false,
          timeDimension: true,
          timeDimensionOptions: {
            timeInterval: dataTimeInterval,
            period: dataPeriod,
            currentTime: actualTime
          }}).setView({lon: 0, lat: 0}, 2);


        // --- LAYOUTS --- //

        // Add OSM tiles
        var clear = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
        });


        // Add Dark OSM tiles
        var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          subdomains: 'abcd',
	        maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        });


        // Add Imagery tiles
        var satelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }).addTo(map);

		//Add Mouse Coordinates
		L.control.mousePosition().addTo(map);
        // Add Zoom control
        L.control.zoom({
            position: 'topright'
        }).addTo(map);


        // Add Polyline Measure
        var optionspoly = {position: 'topright',unit: 'nauticalmiles', showClearControl: true,showBearings: true};
        L.control.polylineMeasure(optionspoly).addTo(map);


        // Navionics Overlay
        var myNavionicsOverlay = new JNC.Leaflet.NavionicsOverlay({
          navKey: 'Navionics_webapi_00583',
          chartType: JNC.NAVIONICS_CHARTS.NAUTICAL,
          isTransparent: false,
          logoPayoff: false,
          zIndex: 1
        });


        // Add openSeaMap Overlay
        var openweathermapClouds = L.tileLayer('https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=4a3f984d1742f11478df5e7ac0845ef5', {
          attribution: 'Weather from <a href="http://openweathermap.org">OpenWeatherMap</a>'
        });

        var openweathermapPrecipitation= L.tileLayer('https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=4a3f984d1742f11478df5e7ac0845ef5', {
          attribution: 'Weather from <a href="http://openweathermap.org">OpenWeatherMap</a>'
        });

        var openweathermapPression = L.tileLayer('https://tile.openweathermap.org/map/pressure_new/{z}/{x}/{y}.png?appid=4a3f984d1742f11478df5e7ac0845ef5', {
          attribution: 'Weather from <a href="http://openweathermap.org">OpenWeatherMap</a>'
        });

        var openweathermapWind = L.tileLayer('https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=4a3f984d1742f11478df5e7ac0845ef5', {
          attribution: 'Weather from <a href="http://openweathermap.org">OpenWeatherMap</a>'
        });

        var openweathermapTemp = L.tileLayer('https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=4a3f984d1742f11478df5e7ac0845ef5', {
          attribution: 'Weather from <a href="http://openweathermap.org">OpenWeatherMap</a>'
        });

        // Add openSeaMap Overlay
        var openSeaMap = L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
          attribution: 'Map data: &copy; <a href="http://www.openseamap.org">OpenSeaMap</a> contributors'
        });


        // Wind
        var baseIndex = 1;
        var wind10mBaseURL = 'https://weather.openportguide.org/weather/wind10m/';
        var wind10mBaseName = 'wind10m_{h}h';
        var wind10mName = '';
        var wind10mArray = [];

        var wind10mLayerGroup = new L.layerGroup([], {});
        wind10mArray.length = map.timeDimension._availableTimes.length;
        var actualTimeIndex = map.timeDimension._currentTimeIndex;
        

        function updateLayer(Layer){ //updates the actual layer
          wind10mLayerGroup.clearLayers();
          wind10mName = wind10mBaseName.replace(/{h}/g, (actualTimeIndex - baseIndex) * actualInterval);
          
          $.getJSON(wind10mBaseURL + wind10mName + ".json", function(data) {
            wind10mName = L.velocityLayer({
                displayValues: true,
                displayOptions: {
                    velocityType: "Wind",
                    emptyString: "No wind data",
                    angleConvention: "MeteoCW",
                    speedUnit: "kt"
                },
                data: data,
                minVelocity: 0,
                maxVelocity: 30,
                particleAge: 90,
                lineWidth: 2,
                particleMultiplier: 0.0033,
                frameRate: 10,
                colorScale: ['#ffffff', '#ebf4e7', '#d7e9ce', '#c3deb3', '#b0d396', '#ffa91e', '#fc9527', '#f78130', '#f06e38', '#e75a41', '#dc464a', '#cf3155', '#be1b63', '#a90374', '#8b008b']
               });
            wind10mLayerGroup.addLayer(wind10mName);
            wind10mArray[actualTimeIndex] = wind10mLayerGroup.getLayer(wind10mLayerGroup.getLayerId(wind10mName));
            
            wind10mLayerGroup.addTo(map);
          });
        }
		


        // ------ TERMINATOR ----- //
        var terminator = L.terminator({fillOpacity:0.2}).addTo(map);
        setInterval(function() {
          terminator.setTime();
        }, 60000);

        // ------- DST DATA ------ //
        $.getJSON( "dst.json"+"?"+Math.random(), function( data ) {
          L.polygon(data, {color: "red", weight: 1}).addTo(map);
        }); 
		
		    // ------- AEZ DATA ------ //
        $.getJSON( "aez.json"+"?"+Math.random(), function( data ) {
          var aez=[];
          //Inversion Lat/Lon
          $.each(data, function(index,value){
          
          aez.push([value[1],value[0]]);
          });
          L.polyline(aez, {color: "red", weight: 1}).bindTooltip("Zone d'Exclusion Antarctique", {sticky:true, direction:'bottom'}).addTo(map);
        }); 
		
        // ------ SIDEBAR ----- //

        var sidebar = L.control.sidebar('sidebar', {
            position: 'left',
            closeButton: 'true'
        });
        map.addControl(sidebar);

        $('#close').click(function(){sidebar.hide();});

        // ------ BOAT DATA ------ //
        var boatPositions = [];
        var foilerBoatsGroup = [];
        var daggerBoardBoatsGroup = [];
        var traces = [];
        var foilerTraceGroup = [];
        var daggerBoardTraceGroup = [];
        var ranking = []; 
		    var heure_dernier_classement;
        
        $.getJSON( "classement.json"+"?"+Math.random(), function( data ) {
          $.each( data, function( key, val ) {
            var latlngs = [];
            var lastPosition = null;
            var lastRotation = null;
            var lastClassement = null;
          
            // --- TRACE ---- //
            $.each( val.classements, function( elemK, elemV ) {
              lastPosition = [elemV.latitude, elemV.longitude];
              lastRotation = elemV.cap;
              latlngs.push(lastPosition);
              lastClassement = elemV;
            });

            latlngs.reverse();
            ranking.push({'id': key, ...lastClassement});
            // Heure dernier classement
            heure_dernier_classement = new Date(lastClassement.Date);
            // Trace boat line
            //var trace = L.polyline(latlngs, {id: 'p_'+key, color: val.couleur, weight: 2}).addTo(map);
            var trace = new L.Wrapped.Polyline(latlngs, {id: 'p_'+key, color: val.couleur, weight: 2}).addTo(map);

            // ----- MARKER ----- //
            
            // Design boat icon
            var width = 40;
            var height = 60;
            var boatIcon = L.icon({
                iconUrl: 'static/img/markers/' + key + '.png',
                iconSize:     [width/1.5, height/1.5],
                iconAnchor:   [width/3, height/3]
            });
          
          // Create boat marker
          var boat = L.marker(lastPosition, {id: key, icon: boatIcon, rotationAngle: lastRotation}).bindTooltip('['+lastClassement.position+ '] ' + val.skipper + ' - ' + val.bateau, {offset:L.point(10,0), direction:'right'});

          // Group by foiler / daggerBoard
          if (val.isFoiler){
            foilerTraceGroup.push(trace);
            foilerBoatsGroup.push(boat);
          } else {
            daggerBoardTraceGroup.push(trace);
            daggerBoardBoatsGroup.push(boat);
          }

          //copy
          traces.push(trace);
          
          // Add click on the boat
          boat.on("click", function(event){
            var id = event.sourceTarget.options.id;
            openSidebar(id);
            map.panTo(lastPosition);
          });

          var dashedTrace = []
          boat.on('mouseover', function(event){
            var id = event.sourceTarget.options.id;
			$.each(foilerBoatsGroup, function(key,val)
			{
			  if(val.options.id!=id){
			    val.setOpacity(0.3);
			    val.setZIndexOffset(0);
			  }
			
			});
			$.each(daggerBoardBoatsGroup, function(key,val)
			{
			  if(val.options.id!=id){
			    val.setOpacity(0.3);
			    val.setZIndexOffset(0);
			  }
			
			});
            $.each( traces, function( key, val ) {
              if(val.options.id == 'p_'+id) {
                val.setStyle({opacity:0});
                dashedTrace.push(new L.Wrapped.Polyline(val.getLatLngs(), {color: val.options.color, weight: 4, dashArray: "8 8", dashSpeed: Math.round(data[id].classements[data[id].classements.length-1].vitesse)}).addTo(map));
              } else{
                val.setStyle({weigh:2, opacity:0.3});
              }
            });
          });

          boat.on('mouseout', function(event){
          	$.each(daggerBoardBoatsGroup, function(key,val)
			{val.setOpacity(1);
			 val.setZIndexOffset(1000);
		    
			});
			$.each(foilerBoatsGroup, function(key,val)
			{val.setOpacity(1);
		    val.setZIndexOffset(1000);
			});
            $.each( traces, function( key, val ) {   
              val.setStyle({opacity:1, weight:2});
            });
            $.each( dashedTrace, function( key, val ) {   
              map.removeLayer(val);
            });
          });
                    
          boatPositions.push(lastPosition);
        });
        
          // Alignement météo sur dernier classement
		 
			var heure_recherche = startTime;
			var index_meteo=0;

			if(heure_dernier_classement>=startTime && heure_dernier_classement<=endTime){
				while(heure_dernier_classement>heure_recherche){
 					index_meteo++;
 					heure_recherche.setHours(heure_recherche.getHours()+actualInterval);
 				}
				if((heure_recherche-heure_dernier_classement)>3*60*60*3600)
				{
					index_meteo--;
				}
				map.timeDimension.nextTime(index_meteo-actualTimeIndex,false);
 				actualTimeIndex=index_meteo;
			}
		  updateLayer(wind10mArray[actualTimeIndex]);
		  //update weather layer based on slider
		  window.setInterval(function() { //check if time index changed
          if (actualTimeIndex != map.timeDimension._currentTimeIndex) {
          actualTimeIndex = map.timeDimension._currentTimeIndex;
          updateLayer(wind10mArray[actualTimeIndex]);
          }
        },100);
		  
          // add Groups to map
          var foilerTraceLayer = L.layerGroup(foilerTraceGroup).addTo(map);
          var daggerBoardTraceLayer = L.layerGroup(daggerBoardTraceGroup).addTo(map); 
          var foilersLayer = L.layerGroup(foilerBoatsGroup).addLayer(foilerTraceLayer).addTo(map);
          var daggerBoardLayer= L.layerGroup(daggerBoardBoatsGroup).addLayer(daggerBoardTraceLayer).addTo(map);        

          // ----- LAYER CONTROL ---- //

          var baseLayers = {
            "Claire" : clear,
            "Foncé" : dark,
            "Satellite" : satelit
            
          };
          
          var overlays = {
            "OpenSeaMap" : openSeaMap,
            "Navionics" : myNavionicsOverlay,
            "Jour/nuit": terminator,
            'Foilers': foilersLayer,
            "Dérives": daggerBoardLayer,
            "Vent (anim)": wind10mLayerGroup,
            'Vent (static)': openweathermapWind,
            'Nuages': openweathermapClouds,
            'Précipitations': openweathermapPrecipitation,
            'Pression': openweathermapPression,
            'Température': openweathermapTemp,
          };

          layerControl = L.control.layers(baseLayers, overlays, {position: 'topleft'});
          layerControl.addTo(map);

          wind10mLayerGroup.on("remove",function(){
            map.removeControl(timeDimensionControl);
          });
          wind10mLayerGroup.on("add",function(){
          timeDimensionControl = L.control.timeDimension({
              position: "bottomright",
              loopButton: false,
              limitSliders: false,
              playButton: false,
              speedSlider: false
            } ).addTo(map);
            });
		  
          // autoFit map
          map.fitBounds(boatPositions);

          // Count boat for skipper count
          $('#skipperCount').html(boatPositions.length);
          
          // ----- SIDEBAR POPULATE FUNCTION ----- //

          function openSidebar(id){
              sidebar.show();
              var skipper = data[id];
              var current = skipper.classements[skipper.classements.length-1];
              
              var vitessePanel = skipper.classements.slice(-12);
              var vitesses = [];
              var vitesse_max = 0;
              var vitesse_min = 100;
              var labels = [];
              var total = 0;
              
              $.each( vitessePanel, function( i, elem ) {
                vitesses.push(elem.vitesse);
                var datetime = moment(elem.Date);
                labels.push(datetime.format('HH:mm'));
                total += elem.vitesse;
                if(elem.vitesse>vitesse_max){
                	vitesse_max=elem.vitesse;
                }
                if(elem.vitesse<vitesse_min){
                	vitesse_min=elem.vitesse;
                }
              });

              var average = total / vitessePanel.length;

              // Stuff
              var wind = (skipper.Meteo.wind.speed*1.94);
              $('#data_skipper_pict').attr('src', 'static/img/avatar/'+id+'.jpg');
              $('#data_skipper_pict').attr('style', 'border-color:'+skipper.couleur+'; box-shadow:0 0 0 10px rgba('+hexToRgb(skipper.couleur)+',0.2);');
              $('#data_skipper').text(skipper.skipper);
              $('#data_team').text(skipper.bateau);
              $('#data_postion').text(current.position);
              if(current.vitesse>0){
                $('#data_speedforce>svg').css('animation', 'rotating '+35/current.vitesse+'s linear infinite');
              }
              $('#data_speed').html('<span>&nbsp;</span><span>'+current.vitesse+'kt</span>');
              $('#data_heading').html('<span>&nbsp;</span><span>'+current.cap+'°</span>');
              $('#data_cap>svg').css('transform', 'rotate('+current.cap+'deg)');
              $('#data_vent').html('<span>Direction: '+skipper.Meteo.wind.deg+'°</span><span>'+wind.toFixed(2)+'kt</span>');
              $('#data_direction>svg').css('transform', 'rotate('+(skipper.Meteo.wind.deg +135) % 360+'deg)');
              $('#data_direction>svg>path').css('fill', windcolor(wind));
              
              if (typeof skipper.Meteo.rain !== 'undefined') {
    				    $('#data_pluie').html('<span>Sur 1 heure</span><span>'+skipper.Meteo.rain["1h"]+'mm</span>');
				      }
              else{
              	$('#data_pluie').html('<span>Sur 1 heure</span><span>0mm</span>');
              }
              
              $('#data_nuage').html('<span>Couverture</span><span>'+skipper.Meteo.clouds.all+'%</span>');
              $('#data_dist').text(current.DTF+' nm');
              $('#data_vmgmax').text(current.VMG+' nds');

              // Foiler
              if (skipper.isFoiler){
                $('#data_foiler').text('foiler').addClass('foiler').removeClass('derive');
              } else {
                $('#data_foiler').text('Dérive').addClass('derive').removeClass('foiler');
              }

              // Speed chart
              var ctx = document.getElementById('speedChart').getContext('2d');

              var sidebarChart = new Chart(ctx, setSideBarChartConfig(labels, vitesses, average, vitesse_min, vitesse_max));
          	  
              // position history
              var htmlData = '';
              $.each(skipper.classements.reverse(), function(key, val) {
              var datetime = moment(val.Date);
               htmlData += '<tr><td>'+datetime.format('DD/MM/YYYY HH:mm')+'</td><td>'+val.position+'</td><td>'+val.VMG+' <span class="grey">kt</span></td></tr>';
              });
              skipper.classements.reverse();
              $('#positionHistory>tbody').html(htmlData);
          }

          // ---- RANKING --- //

          ranking.sort(function(a, b) {
            var keyA = a.position;
            var keyB = b.position;
            // Compare the 2 dates
            if (keyA < keyB) return -1;
            if (keyA > keyB) return 1;
            return 0;
          });



          var htmlData = '';
    
          $.each(ranking, function(key, val) {
            var datetime = moment(val.Date);
            var foiler = (data[val.id].isFoiler === true) ? 'Foiler' :'Dérives';
            var foilerCl = (data[val.id].isFoiler === true) ? 'foiler' :'derive';
            htmlData += '<tr>\
              <td>'+val.position+'</td>\
              <td>'+val.classement_open+'</td>\
              <td><div id="skp"><img style="border-color:'+data[val.id].couleur+'" src="static/img/avatar/'+val.id+'.jpg" /><div><div>'+data[val.id].skipper+'</div><div>'+truncate(data[val.id].bateau, 20)+'<span class="boat-type '+foilerCl+'">'+foiler+'</span></div></div></td>\
              <td>'+val.vitesse.toFixed(1)+' <span class="grey">kt</span></td>\
              <td>'+val.cap+' <span class="grey">°</span></td>\
              <td>'+val.DTL.toFixed(1)+' <span class="grey">nm</span></td>\
              <td>'+val.DTL_open.toFixed(1)+' <span class="grey">nm</span></td>\
              <td>'+val.DTF.toFixed(1)+' <span class="grey">nm</span></td>\
              <td>'+val.VMG.toFixed(1)+' <span class="grey">kt</span></td>\
              <td>'+val.VMG_wp.toFixed(1)+' <span class="grey">kt</span></td>\
              </tr>';
          });
          $('#Ranking>tbody').html(htmlData);
          $("#Ranking").tablesorter();

        });

        $.getJSON( "armel.json", function( armeltrace ) {

          new L.Wrapped.Polyline(armeltrace, {color: "grey", weight: 2, dashArray: [2,4]}).bindTooltip("Armel Le Cléac'h - Banque Populaire / VG2016", {sticky:true}).addTo(map);
        });
      };
    </script>
  </body>
</html>